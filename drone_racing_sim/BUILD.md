# Build and Installation Instructions

## Prerequisites

- **OS**: Ubuntu 22.04 LTS (recommended)
- **ROS2**: Humble (or Foxy/Iron with adjustments)
- **Gazebo**: Ignition Gazebo 6.x or later
- **Python**: 3.10 or later
- **Build Tools**: colcon, cmake

### Quick Setup

```bash
# Install ROS2 Humble (if not already installed)
sudo curl -sSL https://repo.ros2.org/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://repo.ros2.org/ubuntu $(. /etc/os-release && echo $UBUNTU_CODENAME) main" | sudo tee /etc/apt/sources.list.d/ros2.list > /dev/null

sudo apt update
sudo apt install -y ros-humble-desktop ros-humble-gazebo-ros-pkgs

# Install Gazebo Ignition
sudo apt install -y ignition-gazebo-dev

# Install Python dependencies
pip install numpy scipy
```

## Building the Project

### 1. Clone/Prepare Workspace

```bash
cd ~/aigp
# Assumes drone_racing_sim/ already exists
```

### 2. Install Python Dependencies

```bash
cd ~/aigp/drone_racing_sim

# Option A: System-wide install (requires colcon)
pip install -r requirements.txt 2>/dev/null || echo "requirements.txt not found, installing manually..."
pip install rclpy gazebo_ros tf2_geometry_msgs tf2-py vision-msgs

# Option B: Development install
pip install -e .
```

### 3. Build with Colcon

```bash
cd ~/aigp

# Create build directory
colcon build --packages-select drone_racing_core

# Verify build
ls -la ~/aigp/install/drone_racing_core/
```

### 4. Source Setup Files

```bash
# Source ROS2 setup
source /opt/ros/humble/setup.bash

# Source workspace setup
source ~/aigp/install/setup.bash

# Optional: Add to ~/.bashrc for automatic sourcing
echo "source /opt/ros/humble/setup.bash" >> ~/.bashrc
echo "source ~/aigp/install/setup.bash" >> ~/.bashrc
```

## Verification

### Check ROS2 Installation

```bash
ros2 --version
# Expected: ROS 2 humble

source /opt/ros/humble/setup.bash
ros2 run demo_nodes_cpp talker  # In one terminal
ros2 run demo_nodes_py listener  # In another - should receive messages
```

### Check Gazebo Installation

```bash
gazebo --version
# Expected: Gazebo version X.X.X

# Launch empty Gazebo
gazebo
```

### Check Package

```bash
ros2 pkg list | grep drone_racing
# Expected: drone_racing_core

ros2 pkg prefix drone_racing_core
# Expected: /home/shree/aigp/install/drone_racing_core
```

## Environment Variables

### Critical Paths

```bash
# Gazebo model path - add to ~/.bashrc or run before simulation
export GAZEBO_MODEL_PATH="${GAZEBO_MODEL_PATH}:~/aigp/drone_racing_sim/models"
export GAZEBO_RESOURCE_PATH="${GAZEBO_RESOURCE_PATH}:~/aigp/drone_racing_sim"

# ROS2 package path (usually automatic after colcon build)
# Verify:
echo $ROS_PACKAGE_PATH
```

### Troubleshooting Environment

```bash
# If colcon build fails, check dependencies
rosdep install --from-paths ~/aigp/src --ignore-src -r -y

# If ROS2 commands not found, verify sourcing
which ros2
# Expected: /opt/ros/humble/bin/ros2

# If Gazebo models not found
gazebo --verbose   # Look for "No mesh" errors
```

## Directory Structure

After building, you should see:

```
~/aigp/
├── drone_racing_stack/           # Phase 1: Autonomy stack
│   ├── src/
│   ├── tests/
│   └── ...
├── drone_racing_sim/             # Phase 2: Simulation
│   ├── src/
│   │   └── drone_racing_core/
│   │       ├── drone_racing_core/
│   │       │   ├── autonomy_bridge.py
│   │       │   ├── gate_spawner.py
│   │       │   ├── gate_validator.py
│   │       │   ├── visualization.py
│   │       │   ├── metrics_logger.py
│   │       │   └── ...
│   │       ├── setup.py
│   │       └── package.xml
│   ├── urdf/
│   │   └── quadrotor.urdf.xacro
│   ├── models/
│   │   └── gate/
│   │       └── model.sdf
│   ├── worlds/
│   │   └── racing_track.world
│   ├── launches/
│   │   └── racing_sim.launch.py
│   ├── configs/
│   │   └── rviz_config.rviz
│   ├── test_runs/                # Auto-generated during runs
│   └── ...
├── build/                         # Auto-generated by colcon
├── install/                       # Auto-generated by colcon
└── log/                           # Auto-generated by colcon
```

## Build Customization

### Rebuilding After Code Changes

```bash
# Quick rebuild
colcon build --packages-select drone_racing_core

# Full clean rebuild
colcon clean packages --select drone_racing_core
colcon build --packages-select drone_racing_core

# With verbose output
colcon build --packages-select drone_racing_core --event-handlers console_direct+
```

### CMake Configuration

The package uses Python-only build (setuptools). If you add C++ nodes later:

```bash
# Create CMakeLists.txt for C++ compilation
colcon build --cmake-args -DCMAKE_BUILD_TYPE=Release
```

## Offline Use

If you need to work offline after build:

```bash
# The install/ directory contains all built binaries
# You only need to source and run from install/

# Copy to external device
rsync -av ~/aigp/install ~/aigp/drone_racing_sim ~/aigp/drone_racing_stack ~/backup/

# On external machine (after ROS2 installation)
source /opt/ros/humble/setup.bash
source ~/backup/install/setup.bash
# Ready to use
```

## Clean Build/Rebuild

```bash
# Remove all generated files
rm -rf ~/aigp/build ~/aigp/install ~/aigp/log

# Rebuild from scratch
colcon build --packages-select drone_racing_core
```

## Next Steps

After successful build, see:
- [QUICKSTART.md](QUICKSTART.md) - Running simulations
- [README.md](README.md) - Architecture and usage
- [test_runner.py](test_runner.py) - Automated testing
